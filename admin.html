
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | EarnApp</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    :root {
      /* New Premium Color Palette */
      --primary: #8A2BE2;        /* Deep Purple */
      --primary-light: #9D4EDD;
      --secondary: #00C9FF;       /* Electric Blue */
      --accent: #FFD700;          /* Gold */
      --success: #00FFA3;         /* Neon Green */
      --warning: #FFAA00;
      --danger: #FF4D4D;
      --dark: #0D0B1A;
      --card-bg: rgba(25, 20, 45, 0.7);
      --text-primary: #FFFFFF;
      --text-secondary: #B0A9C9;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--dark), #15122A);
      color: var(--text-primary);
      margin: 0;
      overflow-x: hidden;
      min-height: 100vh;
    }
    .header {
      background: rgba(138, 43, 226, 0.15);
      backdrop-filter: blur(12px);
      padding: 1.2rem 1.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(138, 43, 226, 0.3);
    }
    .brand-title {
      font-family: 'Manrope', sans-serif;
      font-weight: 800;
      font-size: 2.1rem;
      background: linear-gradient(90deg, var(--accent), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }
    .admin-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
    }
    .logout-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 10px;
      transition: all 0.25s ease;
    }
    .logout-btn:hover {
      color: var(--accent);
      transform: rotate(15deg) scale(1.1);
    }
    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      padding: 1.8rem 1.5rem;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255, 255, 255, 0.08);
      cursor: pointer;
    }
    .stat-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 14px 36px rgba(138, 43, 226, 0.35);
      border-color: rgba(138, 43, 226, 0.4);
    }
    .stat-icon {
      font-size: 2.4rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, var(--primary-light), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-value {
      font-family: 'Manrope', sans-serif;
      font-size: 2.2rem;
      font-weight: 800;
      margin: 0.4rem 0;
      background: linear-gradient(90deg, #FFFFFF, var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .stat-label {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
    }
    .feature-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      padding: 1.8rem;
      margin: 1.8rem 0;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .feature-title {
      font-family: 'Manrope', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: white;
    }
    .feature-icon {
      font-size: 2rem;
      background: linear-gradient(135deg, var(--primary-light), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .action-btn {
      padding: 0.5rem 1.1rem;
      font-size: 0.9rem;
      border-radius: 12px;
      margin: 0.25rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .status-badge {
      padding: 0.3rem 0.85rem;
      border-radius: 50px;
      font-size: 0.88rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-requested {
      background: rgba(255, 170, 0, 0.15);
      color: #FFD700;
      border: 1px solid rgba(255, 170, 0, 0.3);
    }
    .status-approved {
      background: rgba(0, 255, 163, 0.15);
      color: #00FFA3;
      border: 1px solid rgba(0, 255, 163, 0.3);
    }
    .status-paid {
      background: rgba(0, 201, 255, 0.15);
      color: #00C9FF;
      border: 1px solid rgba(0, 201, 255, 0.3);
    }
    .status-rejected {
      background: rgba(255, 77, 77, 0.15);
      color: #FF4D4D;
      border: 1px solid rgba(255, 77, 77, 0.3);
    }
    .table {
      color: var(--text-primary);
    }
    .table th {
      color: var(--text-secondary);
      font-weight: 600;
    }
    .table td, .table th {
      border-color: rgba(255,255,255,0.08) !important;
    }
    .table-hover tbody tr:hover {
      background: rgba(138, 43, 226, 0.1);
    }
    .export-btn {
      background: linear-gradient(135deg, var(--success), #00E0B0);
      color: #0D0B1A;
      border: none;
      padding: 0.6rem 1.4rem;
      border-radius: 14px;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.25s;
    }
    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 255, 163, 0.3);
    }
    .user-modal .modal-content {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      overflow: hidden;
    }
    .user-modal .modal-header {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 1.2rem 1.5rem;
    }
    .user-modal .modal-body {
      padding: 1.5rem;
    }
    .badge {
      font-weight: 600;
      padding: 0.35em 0.65em;
      border-radius: 6px;
    }
    .badge-admin {
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #0D0B1A;
    }
    .badge-user {
      background: rgba(255,255,255,0.1);
      color: var(--text-secondary);
    }
    .withdrawal-item {
      transition: all 0.25s;
      border-radius: 18px;
      overflow: hidden;
    }
    .withdrawal-item:hover {
      transform: translateX(4px);
      border-left: 4px solid var(--primary);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="brand-title">EarnApp Admin</div>
    <div style="display: flex; align-items: center; gap: 1.2rem;">
      <div class="admin-avatar" id="adminInitial">A</div>
      <button class="logout-btn" id="logoutBtn" title="Logout">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>

  <div class="container-fluid px-4 py-3">
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
      <div class="col-6 col-md-3">
        <div class="stat-card" id="usersCard">
          <div class="stat-icon">
            <i class="bi bi-people-fill"></i>
          </div>
          <div class="stat-value" id="totalUsers">0</div>
          <div class="stat-label">Total Users</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-currency-rupee"></i>
          </div>
          <div class="stat-value" id="totalPayouts">â‚¹0</div>
          <div class="stat-label">Total Payouts</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-clock-history"></i>
          </div>
          <div class="stat-value" id="pendingWithdrawals">0</div>
          <div class="stat-label">Pending Requests</div>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-person-plus-fill"></i>
          </div>
          <div class="stat-value" id="todaySignups">0</div>
          <div class="stat-label">Today Signups</div>
        </div>
      </div>
    </div>

    <!-- Withdrawal Queue -->
    <div class="feature-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="feature-title">
          <i class="bi bi-wallet2 feature-icon"></i> Withdrawal Requests
        </div>
        <button class="export-btn" id="exportCsv">
          <i class="bi bi-file-earmark-excel"></i> Export CSV
        </button>
      </div>
      <div id="withdrawalQueue">
        <p class="text-muted text-center">Loading withdrawal requests...</p>
      </div>
    </div>
  </div>

  <!-- USERS MODAL -->
  <div class="modal fade user-modal" id="usersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">All Users</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-dark">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Balance (Coins)</th>
                  <th>Referral Code</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr><td colspan="6" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      getDocs, 
      orderBy, 
      updateDoc, 
      doc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ðŸ”¥ REPLACE WITH YOUR CONFIG
    const firebaseConfig = {
  apiKey: "AIzaSyDPJTWyFVmKfqbCKABmgwVBMAq3ztUh-c0",
  authDomain: "earning-app-7aaa2.firebaseapp.com",
  databaseURL: "https://earning-app-7aaa2-default-rtdb.firebaseio.com",
  projectId: "earning-app-7aaa2",
  storageBucket: "earning-app-7aaa2.firebasestorage.app",
  messagingSenderId: "275234274991",
  appId: "1:275234274991:web:e35845916bc1932f6e9e5a",
  measurementId: "G-2YNNENL1RZ"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentAdmin = null;

    const logoutBtn = document.getElementById('logoutBtn');
    const usersCard = document.getElementById('usersCard');
    const usersTableBody = document.getElementById('usersTableBody');
    const withdrawalQueueEl = document.getElementById('withdrawalQueue');
    const exportCsvBtn = document.getElementById('exportCsv');
    const adminInitialEl = document.getElementById('adminInitial');

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'admin-login.html';
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'admin-login.html';
        return;
      }

      const userDoc = await getDocs(query(collection(db, 'users'), where('email', '==', user.email)));
      if (userDoc.empty || userDoc.docs[0].data().role !== 'admin') {
        alert('Access denied. Admins only.');
        await signOut(auth);
        window.location.href = 'admin-login.html';
        return;
      }

      currentAdmin = user;
      adminInitialEl.textContent = user.email.charAt(0).toUpperCase();
      
      loadAnalytics();
      loadWithdrawalQueue();
    });

    async function loadAnalytics() {
      try {
        const usersSnap = await getDocs(collection(db, 'users'));
        document.getElementById('totalUsers').textContent = usersSnap.size;

        let totalPayout = 0;
        let pendingCount = 0;
        const today = new Date();
        today.setHours(0,0,0,0);
        let todayCount = 0;

        const withdrawalsSnap = await getDocs(collection(db, 'withdrawals'));
        withdrawalsSnap.forEach(doc => {
          const w = doc.data();
          if (w.status === 'paid' || w.status === 'approved') {
            totalPayout += w.amount || 0;
          }
          if (w.status === 'requested') {
            pendingCount++;
          }
          if (w.createdAt?.seconds) {
            const createdAt = new Date(w.createdAt.seconds * 1000);
            if (createdAt >= today) {
              todayCount++;
            }
          }
        });

        document.getElementById('totalPayouts').textContent = `â‚¹${totalPayout}`;
        document.getElementById('pendingWithdrawals').textContent = pendingCount;
        document.getElementById('todaySignups').textContent = todayCount;
      } catch (e) {
        console.error("Analytics error:", e);
      }
    }

    usersCard.addEventListener('click', async () => {
      const modal = new bootstrap.Modal(document.getElementById('usersModal'));
      modal.show();
      
      usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading users...</td></tr>';
      
      try {
        const usersSnap = await getDocs(query(collection(db, 'users'), orderBy('createdAt', 'desc')));
        let html = '';
        usersSnap.forEach(doc => {
          const u = doc.data();
          const roleBadge = u.role === 'admin' 
            ? '<span class="badge badge-admin">ADMIN</span>' 
            : '<span class="badge badge-user">USER</span>';
          html += `
            <tr>
              <td>${u.name || 'â€”'}</td>
              <td>${u.email || 'â€”'}</td>
              <td>${u.phone || 'â€”'}</td>
              <td>${u.balance || 0}</td>
              <td>${u.referralCode || 'â€”'}</td>
              <td>${roleBadge}</td>
            </tr>
          `;
        });
        usersTableBody.innerHTML = html || '<tr><td colspan="6" class="text-center">No users found.</td></tr>';
      } catch (e) {
        usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load users.</td></tr>';
      }
    });

    async function loadWithdrawalQueue() {
      withdrawalQueueEl.innerHTML = '<p class="text-muted text-center">Loading...</p>';
      
      try {
        const q = query(
          collection(db, 'withdrawals'),
          orderBy('createdAt', 'desc')
        );
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          withdrawalQueueEl.innerHTML = '<p class="text-muted text-center">No withdrawals yet.</p>';
          return;
        }

        let html = '';
        snapshot.forEach(doc => {
          const w = doc.data();
          const date = w.createdAt ? new Date(w.createdAt.seconds * 1000).toLocaleString() : 'â€”';
          const statusClass = {
            'requested': 'status-requested',
            'approved': 'status-approved',
            'paid': 'status-paid',
            'rejected': 'status-rejected'
          }[w.status] || 'status-requested';

          let actions = '';
          if (w.status === 'requested') {
            actions = `
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-success action-btn approve-btn" data-id="${doc.id}">
                  <i class="bi bi-check-lg"></i> Approve
                </button>
                <button class="btn btn-danger action-btn reject-btn" data-id="${doc.id}">
                  <i class="bi bi-x-lg"></i> Reject
                </button>
              </div>
            `;
          }

          html += `
            <div class="feature-card withdrawal-item mb-4" style="background: rgba(25, 20, 45, 0.5);">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="h5 mb-1">â‚¹${w.amount || 0}</div>
                  <div class="text-muted small mb-1"><i class="bi bi-upi"></i> ${w.details || 'â€”'}</div>
                  <div class="text-muted small"><i class="bi bi-person"></i> ${w.userId?.substring(0,8)}...</div>
                </div>
                <div class="text-end">
                  <div class="status-badge ${statusClass}">${w.status?.toUpperCase() || 'UNKNOWN'}</div>
                  <div class="text-muted small mt-1">${date}</div>
                </div>
              </div>
              ${actions}
            </div>
          `;
        });
        withdrawalQueueEl.innerHTML = html;

        document.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', () => handleApprove(btn.dataset.id));
        });
        document.querySelectorAll('.reject-btn').forEach(btn => {
          btn.addEventListener('click', () => handleReject(btn.dataset.id));
        });
      } catch (error) {
        console.error("Withdrawal load error:", error);
        withdrawalQueueEl.innerHTML = `<p class="text-danger text-center">Error: ${error.message}</p>`;
      }
    }

    async function handleApprove(withdrawalId) {
      if (!confirm('Approve this withdrawal?')) return;
      
      try {
        await updateDoc(doc(db, 'withdrawals', withdrawalId), {
          status: 'approved',
          adminNote: 'Approved by admin',
          updatedAt: serverTimestamp()
        });
        alert('âœ… Withdrawal approved!');
        loadWithdrawalQueue();
        loadAnalytics();
      } catch (e) {
        alert('Failed to approve.');
      }
    }

    async function handleReject(withdrawalId) {
      const note = prompt('Reason for rejection (optional):');
      if (note === null) return;
      
      try {
        await updateDoc(doc(db, 'withdrawals', withdrawalId), {
          status: 'rejected',
          adminNote: note || 'Rejected by admin',
          updatedAt: serverTimestamp()
        });
        alert('âŒ Withdrawal rejected!');
        loadWithdrawalQueue();
        loadAnalytics();
      } catch (e) {
        alert('Failed to reject.');
      }
    }

    exportCsvBtn.addEventListener('click', async () => {
      try {
        const withdrawals = await getDocs(collection(db, 'withdrawals'));
        let csv = 'ID,User ID,Amount (â‚¹),UPI ID,Status,Date\n';
        
        withdrawals.forEach(doc => {
          const w = doc.data();
          const date = w.createdAt ? new Date(w.createdAt.seconds * 1000).toISOString().split('T')[0] : '';
          csv += `"${doc.id}","${w.userId}","${w.amount}","${w.details}","${w.status}","${date}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `earnapp_withdrawals_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('âœ… CSV exported successfully!');
      } catch (e) {
        alert('Export failed.');
   }
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>